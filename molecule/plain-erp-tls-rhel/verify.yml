---
### Validates that SASL protocol is PLAIN on all components.
### Validates that ERP is accessible over HTTPS.
### Validates that Control Center is avaiable over HTTP.
### Validates that Control Center has truststore in place.

- name: Verify - kafka_controller
  hosts: kafka_controller
  gather_facts: false
  tasks:
    - name: Check process role
      import_role:
        name: confluent.test
        tasks_from: check_property.yml
      vars:
        file_path: /etc/kafka/server.properties
        property: process.roles
        expected_value: controller

    - name: Check listener
      import_role:
        name: confluent.test
        tasks_from: check_property.yml
      vars:
        file_path: /etc/kafka/server.properties
        property: listeners
        expected_value: CONTROLLER://:9093

    - name: Check quorum voters
      import_role:
        name: confluent.test
        tasks_from: check_property.yml
      vars:
        file_path: /etc/kafka/server.properties
        property: controller.quorum.voters
        expected_value: 9991@controller1:9093,9992@controller2:9093,9993@controller3:9093

- name: Verify - kafka_broker
  hosts: kafka_broker
  gather_facts: false
  tasks:
    - name: Check process role
      import_role:
        name: confluent.test
        tasks_from: check_property.yml
      vars:
        file_path: /etc/kafka/server.properties
        property: process.roles
        expected_value: broker
      when: kraft_enabled|bool

    - import_role:
        name: confluent.test
        tasks_from: check_property.yml
      vars:
        file_path: /etc/kafka/server.properties
        property: listener.name.internal.sasl.enabled.mechanisms
        expected_value: PLAIN

    - import_role:
        name: confluent.test
        tasks_from: check_property.yml
      vars:
        file_path: /etc/kafka/server.properties
        property: confluent.http.server.listeners
        expected_value: https://0.0.0.0:8090

- name: Verify - control_center
  hosts: control_center
  gather_facts: false
  tasks:
    - import_role:
        name: confluent.test
        tasks_from: check_property.yml
      vars:
        file_path: /etc/confluent-control-center/control-center-production.properties
        property: confluent.controlcenter.rest.ssl.truststore.location
        expected_value: /var/ssl/private/control_center.truststore.jks

    - import_role:
        name: confluent.test
        tasks_from: check_property.yml
      vars:
        file_path: /etc/confluent-control-center/control-center-production.properties
        property: confluent.controlcenter.rest.listeners
        expected_value: http://0.0.0.0:9021
